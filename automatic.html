<html>

<head>

<style>
body {
  overflow: auto;
  background-color: black;
  color: navajowhite;
  font-weight: bold;
  font-size: 3em;
  text-align: center;
  height: 100%;
  padding-bottom: 0.5em;
}
h1 { font-size: 1em; text-align: right; }
button {
    font-size: 0.7em;
    background: black;
    border-radius: 40px;
    color: white;
    border-style: dotted;
    border-color: white;
    margin: 0.3em;
    padding: 0.5em;
}

footer { font-size: 0.5em; text-align: center; position: absolute; bottom:0; z-index:1030;}

/* pretend were having color language */

span:nth-child(4n+0) { color: tomato; }
span:nth-child(4n+1) { color: deepskyblue; }
span:nth-child(4n+2) { color: lawngreen; }
span:nth-child(4n+3) { color: gold; }
.fun {
    display: inline-block;
    text-align: left;
    border: 5px solid green;
    padding: 3px;
    margin: 3px;
}
.args {
    position: relative;
    top: 0px;
    display: inline-block;
    text-align: left;
    border: 5px solid red;
    padding: 3px;
    margin: 3px;
    margin-left: 1em;
}
</style>

</head>

<script>
  aaa = '0';
  function dom(id, optData, opt, optStyle) {
      let d = (typeof id == 'string') ?
	  document.getElementById(id) : id;
      if (!d) alert('dom(): no such dom id='+id);
      if (optData === undefined) return d;
      let prefix = '';
      if (dom.log || opt && opt.indexOf('l') >= 0) {
	  //prefix += new Date().toISOString();
	  // TODO: want ms?
	  prefix += new Date().toTimeString().substring(0, 8);
      }
      if (prefix != '') prefix += ': ';
  
      let w = d;
      let append = opt && opt.indexOf('a') >= 0;
      let prepend = opt && opt.indexOf('p') >= 0;
      if (append || prepend) {
	  w = document.createElement('div');
	  w.style = optStyle;
      } else if (optStyle) {
	  w.style = optStyle;
      }

      // TODO: this needs a pretty printer!
      if (opt && opt.indexOf('h') >= 0) {
	  // TODO: smaller font?
	  if (prefix == '')
	      d.appendChild(document.createTextNode(prefix));
	  w.innerHTML = optData;
      } else {
	  w.innerText = prefix+optData;
      }

      if (prepend)
	  d.insertAdjacentElement('afterbegin', w);
      if (append)
	  d.appendChild(w);

      return d;
  }
  // TODO: replace by dom
  function domT(id, ...rest){
      let d = dom(id);
      if (rest.length == 0)
	  d.innerText = '';
      else if (rest.length == 1)
	  d.innerText = '' + rest[0];
      else
	  d.innerText = rest.join(' ');
//	  d.innerText = d.innerText + JSON.stringify(rest);
      // TODO: add better pretty printer
      // especially for special objects
      // like: event, error, dom
  }
</script>

<script>
  function code2html(code) {
      // https://stackoverflow.com/questions/1496826/check-if-a-single-character-is-a-whitespace
      let whitespace = ' \f\n\r\t\v\u00A0\u2028\u2029',
	  openparen = '{[(',
	  closeparen = ')]}',
	  breakchars = whitespace + openparen + closeparen;

      if (!code.length) return code;
      let c = code[0], r = code.substring(1);
      if ('{[('.indexOf(c) >= 0) {
	  // find posittion after breakchar
	  let i = 1;
	  while (i < code.length &&
		 breakchars.indexOf(code[i]) < 0)
	  {
	      console.log('ch>'+code[i]+'< code=' + code[i].charCodeAt(0));
	      i++;
	  }
	  // include any space
	  while (whitespace.indexOf(code[i]) >= 0) i++;
	  let f = code.substring(0, i);
	  let r = code.substring(i);
	  console.log('--- i='+i + 'f>'+f + '< r>'+'<');
	  return '<span class=fun>' + f +
	      '<span class=args>' +
	      code2html(r);
      } else if ('}])'.indexOf(c) >= 0) {
	  return '</span>' + c +
	      '</span>' +
	      code2html(r);
      } else if (c == '"') {
	  let i = 1;
	  while (i < code.length &&
		 code[i] != '"')
	      i++;
	  i++; // include the quote
	  // include any space
	  while (whitespace.indexOf(code[i]) >= 0) i++;
	  c = '<span class=fun>' + code.substring(0, i) + '</span>'
	  r = code.substring(i);
//      } else if (true) {
      } else if (false) {
	  let i = 1;
	  while (i < code.length &&
		 breakchars.indexOf(code[i]) < 0)
	      i++;
	  // i is now at unwanted char
	  // include any space
	  while (whitespace.indexOf(code[i]) >= 0) i++;
	  i--; 
	  c = '<span class=fun>' + code.substring(0, i) + '</span>'
	  r = code.substring(i);
      }
      //return '_'+c+'-' + code2html(r)
      return c + code2html(r)
  }
					 
  // basically just take all the text!
  function dom2code(idom) {
      idom = dom(idom);
      return idom.innerText;
  }
  
  var example_default = 'fac';
  var example_choice = 'foobar';
  var examples = {
      fac: '{fac^n (product (iota 1 n))}',
      math: '(+ 11111 (* 2222 3333 4444) (- 55555 666))',
      foobar: '(foo 3 (bar 4 3) "foobar")',
  }
  function example(name) {
      aaa += 'A';
      let code = examples[name];
      try {
	  dom('exp').innerHTML = code2html(code);
	  aaa += 'B';
      } catch(e) {
	  aaa += 'E';
	  doError(e);
      }
  }
</script>
  
<script>
  aaa += '1';
  function message(...rest) {
      return domT('message', ...rest);
  }
  function doError(e, ...rest) {
      return domT('message', 'Error: ' + e, ...rest);
  }
  aaa += '2';
  aaa += '3';
</script>

<script>
  aaa += '4';
  function doKey(e) {
      let a = e.altKey;
      let c = e.ctrlKey;
      let k = e.key;
      message('event='+e, e, 'c='+c, 'alt='+a, 'key='+e.key);

      // some browsers don't implement
      if (c && k == 'r')
	  window.location.reload();
      if (c && k  == 'e')
	  example();
 
      // insert box for function
      if (k == '(')
	  message('open paren');
      // skip forward to after
      if (k == ')')
	  message('close paren');

      return false;
  }
  aaa += '5';
  // TODO: add concept of
  // user
  // - user. {
  //     fullname, email, we-blink, namespaces,
  //     default-namespace, init-namespace}
  // - user.namespace {
  //     name, functions-list}
  //     namespace should really just be
  //     a function that "includes"/set path
  // - user.namespace.function { current-def, 
  //     name, history count?, history intries
  // - user.namespace.function~000VER
  //     when a fun is updated, it's
  //     logged + add new version + update current
  // - user.namespace.log.stardate[.user]
  //     
  
  // store using window.localStorage
  // (window.sessionStorage)
  // (could stor inside webpage, load/save)

  function put(n, v) {
      return localStorage.setItem(n, v);
  }
  function get(n) {
      return localStorage.getItem(n);
  }

  function save() {
      let x = dom2code('exp');
      put('exp', x);

      message('saved');
  }
  function load() {
      let x = get('exp');
      if (x != null)
	  dom('exp', x, 'h');

      message('loaded');
  }
  document.addEventListener('visibilitychange', function doVis(e) {
      return;
      if (document.visibilityState == 'visible') {
	  // most browser focus, not opera
	  // this  still doesn't do anything
//	  dom('exp').focus();
	  load();
      } else {
	  save();
      }
  }, false);
    
</script>

<body spellcheck=false onkeydown='doKey(event);' onerror='doError(error);' onload='//xdom("exp").focus();'>

<!-- set some overflow so it doesn't resize window-->
<div id=old style='color: white; position: absolute; top: 0; right: 0'>
OLD
</div>

<div id=message style='text-align:left; font-size:0.5em;'></div>
<br/>
<button id=aaa></button>

<script>
  aaa += '6';
  tick = 0;
  function dbg() {
      tick++;
      let x;
      try  {
	  x = document.hasFocus();
      } catch(e) {
	  x = 'ERROR: ' + e;
      }
      let h = document.visibilityState;
      dom('aaa').innerHTML = '' + aaa + ', tick=' + tick + ' focus=' + x + ' vis=' + h;
//      dom("exp").focus();
  }
  aaa += '7';
  setInterval(dbg, 1000);
</script>

<h1>Automatic Lettering</h1>

<div style='width:100%; text-align:justify;'>
  <button>history</button>
  <button>list</button>
  <button>fact</button>
  <button>send</button>
  <button>download</button>
  <button>comm</button>
  <button onclick='save();'>save</button>
  <button onclick='load();'>load</button>
  <button onclick='dom("exp").innerHTML=code2html(dom("exp").innerText);'>prettyprint</button>
  <button onclick='dom("exp", dom2code("exp"));'>unpretty</button>
  <button onclick='example(example_choice)'>example</button>
</div>

<div style='position:absolute; width:100%; height:80%'>
<span id=exp autofocus contenteditable='true' style='margin:0; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);'>
</span>
</span>

<script>
  example(example_default);
</script>

<footer style='font-size:0.5em'>(c) Alienna Automatic Lettering Corporation</footer>

<script id=lastscript src='lastmodified.js'>
</script>

<script>
  // TODO: only enable in debug mode
  var lastmodified;
  setInterval(()=>{
      // delayed setup until browser ready
      if (!lastmodified
	  && typeof(getLastModified) == 'function') {
	  aaa += 'U';
	  lastmodified = getLastModified();
      }
      if (!lastmodified) return;

      let s = Date.now()/1000 - lastmodified;
	      
      // TODO: give user reload button
      let txt = Math.round(s) + 's';
      if (getLastModified() > lastmodified) {
	  let old = Date.now()/1000 - getLastModified();
	  txt = 'Outdated by ' + Math.round(old) + 's ' + txt;
      }
      domT('old', txt);
  }, 1000);

  // poll for change
  setInterval(()=>{
      let o = document.getElementById('lastscript');
      o.parentNode.removeChild(o);
      let s = document.createElement('script');
      s.id = 'lastscript';
      s.src = 'lastmodified.js?' + Date.now();
      document.body.appendChild(s);
  }, 1000);
</script>

<!-- TODO: move this up to top, but it requires, dom function, should it provide it, or an util library? -->
<script id=lastscript src='jsconsole.js'>
</script>

<script src="https://cdn.jsdelivr.net/npm/idb-keyval@3/dist/idb-keyval-iife.js">
</script>

<script>
  var db=idbKeyval;
  console.log('db1');
  db.set('hello', 'world');
  console.log('db2');
// gives error:
//  db.get('hello', 'world').then(
//      val => console.log('val=', val));
  console.log('db4');
</script> 

</body>
</html>
